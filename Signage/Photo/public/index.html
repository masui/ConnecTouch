<html>
  <head>
    <script src="/javascripts/jquery.min.js"></script>
    <script src="/javascripts/mail.js"></script>
    <link rel="stylesheet" href="style.css" />
    <script>
      window.onload = () => {
        /*5番ラズパイのLinksを監視する*/
        const observeReaderId = "192.168.0.204";
        /*取得したlinksをローカルの配列として保持する*/
        let storedLinks = [];
        const startTime = Date.now();
        const apiMaxLength = 10;
        let pictureUserId = "";
        let nowTaking = false;
        /*ポーリングする関数*/
        const pollingLinks = async () => {
          /*192.168.0.200/linksから紐付いたlinksを取得する*/
          /*Paramsにidを追加しない場合全てのリーダーのイベントを取得できる*/
          const endPointUrl = `http://192.168.0.200/links?id=${observeReaderId}&limit=${apiMaxLength}`;
          try {
            const request = await fetch(endPointUrl);
            /*新しい配列*/
            const loadedLinks = await request.json();
            /*新しく追加されたLinksを求める*/
            if (storedLinks.length > 0) {
              getDiff(storedLinks, loadedLinks);
            }
            /*ローカルの配列を新しい配列に上書きする*/
            storedLinks = loadedLinks;
          } catch (error) {
            console.log(error);
          }
        };
        /*ポーリングする関数を毎秒呼び出す*/
        setInterval(() => {
          pollingLinks();
        }, 1000);

        const canvas = document.getElementById("canvas");
        const photo = document.getElementById("photo");

        const width = (window.innerHeight * 4) / 3;
        const height = window.innerHeight;
        const constraints = (window.constraints = {
          audio: false,
          video: true,
        });
        const stamp1_image = new Image();
        stamp1_image.crossOrigin = "anonymous";
        stamp1_image.src = "assets/kanban.png";
        const stamp1 = {
          image: stamp1_image,
          x: 50,
          y: 50,
          w: 315,
          h: 200,
        };

        function handleSuccess(stream) {
          const video = document.querySelector("video");
          video.srcObject = stream;
        }

        function handleError(error) {
          if (error.name === "ConstraintNotSatisfiedError") {
            let v = constraints.video;
            console.log(
              `The resolution ${v.width.exact}x${
                v.height.exact
              } px is not supported by your device.`
            );
          } else if (error.name === "PermissionDeniedError") {
            console.log(
              "Permissions have not been granted to use your camera and " +
                "microphone, you need to allow the page access to your devices in " +
                "order for the demo to work."
            );
          }
          console.log(`getUserMedia error: ${error.name}`, error);
        }

        async function init(e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia(
              constraints
            );
            handleSuccess(stream);
            //e.target.disabled = true;
          } catch (e) {
            handleError(e);
          }
        }

        init();

        const takepicture = () => {
          const context = canvas.getContext("2d");
          const resultDom = document.getElementById("result");
          if (width && height) {
            canvas.width = width;
            canvas.height = height;
            context.drawImage(video, 0, 0, width, height);
            context.drawImage(
              stamp1.image,
              stamp1.x,
              stamp1.y,
              stamp1.w,
              stamp1.h
            );
            const data = canvas.toDataURL("image/png");
            savePicture(data, pictureUserId);

            resultDom.style.display = "block";
            resultDom.setAttribute("src", "./assets/white.gif");
            setTimeout(() => {
              // $(".stamp").css({
              //   display: "",
              // });
              resultDom.setAttribute("src", data);
            }, 100);

            setTimeout(() => {
              hideStamps();
              resultDom.setAttribute("src", "");
              resultDom.style.display = "none";
              $(".titleString").css({
                display: "block",
              });
              nowTaking = false;
            }, 7000);
          } else {
            clearphoto();
          }
        };

        const savePicture = (base64URL, cardId) => {
          console.log(cardId);
          $.ajax({
            url: "http://localhost:8888/",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              img: base64URL,
              cardId: cardId,
            }),
            success: data => {
              console.log("succes", data);
            },
            error: data => {
              console.log("Error: " + data);
            },
          });
        };

        const countDown = () => {
          nowTaking = true;
          $(".titleString").css({
            display: "none",
          });
          setStamps();
          const defaultTimes = 5;
          let times = defaultTimes;
          const countDom = document.getElementById("count");
          countDom.innerHTML = times;
          let timerId = setInterval(() => {
            times--;
            countDom.innerHTML = times;
            if (times == 0) {
              countDom.innerHTML = "";
              takepicture();
              clearInterval(timerId);
              countDom.innerHTML = "";
            }
            if (times <= -1) {
            }
          }, 1000);
        };

        const setStamps = () => {
          originalPoint = {
            x: (window.innerWidth - (window.innerHeight * 4) / 3) / 2,
            y: 0,
          };
          $("#stamp1").css({
            left: `${originalPoint.x + stamp1.x}px`,
            top: `${originalPoint.y + stamp1.y}px`,
            width: `${stamp1.w}px`,
            height: `${stamp1.h}px`,
            display: "block",
          });
        };

        const hideStamps = () => {
          $("#stamp1").css({
            display: "none",
          });
        };

        /*ローカルのlinksと毎秒取得する新鮮なlinksとの差分をとる関数*/
        const getDiff = (oldLinks, newLinks) => {
          /*newLinksにあってoldLinksに無いものは新しいものとする*/
          /*あるかないかの確認はmongoDBのレコードIdを元に行う*/
          const oldIdArray = oldLinks.map(link => link._id.$oid);
          /*レコードIdを元に存在しているかを真偽値で返す関数*/
          const isContained = link => {
            return oldIdArray.includes(link._id.$oid);
          };

          /*newLinksにあってoldLinksに無いものだけを集めた配列を作る*/
          const diffLinks = newLinks.reduce((prev, curr) => {
            if (!isContained(curr)) {
              prev.push(curr);
            }
            return prev;
          }, []);

          if (diffLinks.length != 0 || diffLinks.length < 2) {
            console.log(
              `新しいタッチイベントが${diffLinks.length}件発生しました!`
            );
            /*新規に読み込むと昔のlinkも読み込んでしまうので制限する*/
            /*例えば自分が1番の場合は監視するフィルタも作れる*/
            diffLinks.forEach(link => {
              /*リーダーIDが自分のIDと一致する場合*/
              if (link.link[0] === observeReaderId) {
                console.log(`${link.link[1]}が私にタッチしたので撮影します`);
                pictureUserId = link.link[1];
                // takepicture();
                !nowTaking && countDown();
                // mailsend('hykwtakumin@gmail.com', '5番にタッチ', `${link.link[1]}が私にタッチした!`)
              }
            });
          }
        };
      };
    </script>
  </head>

  <body>
    <div class="titleWrapper">
      <div class="titleString">タッチすると撮影!!</div>
    </div>
    <div class="videoWrapper">
      <video id="video" width="960" height="720" autoplay></video>
    </div>
    <div class="countWrapper">
      <div id="count" class="count"></div>
    </div>
    <div class="resultWrapper">
      <img id="result" class="result" />
    </div>

    <canvas id="canvas"></canvas>
    <img src="/assets/kanban.png" alt="" id="stamp1" />
  </body>
</html>
